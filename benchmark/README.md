# Kotlin Avro Benchmark

This project contains a benchmark that compares the serialization / deserialization performance of the following avro libraries:

- [Avro4k](https://github.com/avro-kotlin/avro4k/)
- [Jackson Avro](https://github.com/FasterXML/jackson-dataformats-binary/tree/master/avro)
- [Avro (using ReflectData)](https://avro.apache.org/)

Each benchmark is executed with the following configuration:
- Reading from a prepared byte array
- Writing to a null output stream
- All with the exact same schema generated by avro4k
- Generating a maximum of use cases:
  - nullable fields
  - unions
  - arrays
  - records
  - enums
  - primitives (string, int, float, double, boolean)
  - logical types (date, timestamp-millis, char, uuid)
- not benchmarking uuid as jackson uses a different representation (fixed) than avro4k and apache avro (string)

## Results

Computer: Macbook air M2

```
Benchmark                                                       Mode   Cnt     Score       Error   Units
c.g.a.b.complex.ApacheAvroReflectBenchmark.read                  thrpt    5   29295.192 ±  319.312  ops/s
c.g.a.b.complex.Avro4kBenchmark.read                             thrpt    5   25766.052 ±  368.664  ops/s
c.g.a.b.complex.Avro4kGenericWithApacheAvroBenchmark.read        thrpt    5   16209.174 ±  203.406  ops/s

c.g.a.b.complex.ApacheAvroReflectBenchmark.write                 thrpt    5   46823.034 ± 2011.928  ops/s
c.g.a.b.complex.Avro4kBenchmark.write                            thrpt    5   44890.274 ± 1080.358  ops/s
c.g.a.b.complex.JacksonAvroBenchmark.write                       thrpt    5   34798.967 ± 2787.370  ops/s
c.g.a.b.complex.Avro4kGenericWithApacheAvroBenchmark.write       thrpt    5   24803.165 ± 1288.472  ops/s

c.g.a.b.simple.Avro4kSimpleBenchmark.read                        thrpt    5  213794.225 ± 9560.253  ops/s
c.g.a.b.simple.ApacheAvroReflectSimpleBenchmark.read             thrpt    5  212685.281 ± 2408.201  ops/s
c.g.a.b.simple.Avro4kGenericWithApacheAvroSimpleBenchmark.read   thrpt    5  149715.561 ± 2054.725  ops/s
c.g.a.b.simple.JacksonAvroSimpleBenchmark.read                   thrpt    5   62663.528 ± 2370.041  ops/s

c.g.a.b.simple.Avro4kSimpleBenchmark.write                       thrpt    5  328514.289 ± 1119.183  ops/s
c.g.a.b.simple.ApacheAvroReflectSimpleBenchmark.write            thrpt    5  253784.541 ± 8960.212  ops/s
c.g.a.b.simple.Avro4kGenericWithApacheAvroSimpleBenchmark.write  thrpt    5  169881.518 ± 2879.094  ops/s
c.g.a.b.simple.JacksonAvroSimpleBenchmark.write                  thrpt    5  128048.496 ± 6859.076  ops/s

c.g.a.b.lists.JacksonAvroListsBenchmark.read                     thrpt    5       7.865 ±    0.488  ops/s
c.g.a.b.lists.Avro4kListsBenchmark.read                          thrpt    5       6.493 ±    0.211  ops/s
c.g.a.b.lists.Avro4kGenericWithApacheAvroListsBenchmark.read     thrpt    5       5.416 ±    0.170  ops/s
c.g.a.b.lists.ApacheAvroReflectListsBenchmark.read               thrpt    5       4.628 ±    1.104  ops/s

c.g.a.b.lists.ApacheAvroReflectListsBenchmark.write              thrpt    5      10.237 ±    0.334  ops/s
c.g.a.b.lists.Avro4kListsBenchmark.write                         thrpt    5       8.104 ±    0.132  ops/s
c.g.a.b.lists.JacksonAvroListsBenchmark.write                    thrpt    5       5.881 ±    0.924  ops/s
c.g.a.b.lists.Avro4kGenericWithApacheAvroListsBenchmark.write    thrpt    5       4.721 ±    0.249  ops/s

```

> [!WARNING]
> JacksonAvroBenchmark.read is failing because of a bug in the library when combining kotlin and avro format.

> [!NOTE]
> To add the relative difference, just ask to chatgpt "can you add another column in this benchmark that indicates the relative difference in percent regarding
> Avro4kDirectBenchmark:"

## Run the benchmark locally

Just execute the benchmark:

```shell
../gradlew benchmark
```

You can get the results in the `build/reports/benchmarks/main` directory.

## Other information

Thanks for [@twinprime](https://github.com/twinprime) for this initiative.
